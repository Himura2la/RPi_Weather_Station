<html>
	<head>
		<meta charset="utf-8">
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/globalize/0.1.1/globalize.min.js"></script>
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/globalize/0.1.1/cultures/globalize.cultures.js"></script>
		<script type="text/javascript" src="http://cdn3.devexpress.com/jslib/14.2.5/js/dx.chartjs.js"></script>
		<!--script type="text/javascript" src="js/papaparse.min.js"></script-->
	</head>

		<script type="text/javascript">
			var sField = 'Timestamp'
			var tInField = 'TempIn'
			var tInName = 'Temperature Inside (°C)'
			var tOutField = 'TempOut'
			var tOutName = 'Temperature Outside (°C)'
			var luxField = 'Lightness'
			var luxName = 'Lightness (Lux)'
			var pField = 'Pressure'
			var pName = 'Pressure (hPa)'

			var dataSize = 2017
			var initCut = 1440
			var sMin, sMax, sInit

			var tGauge, mainChart, hGauge, rangeSelector


			var dataSource = new DevExpress.data.DataSource({
			    load: function (loadOptions) {
			        var d = $.Deferred();
			        $.ajax({
			            url: "http://himura15.dlinkddns.com/weather.json",
			            data: {limit: dataSize},
			            dataType: "jsonp",
			            jsonp: "callback",
			            success: function(data) {
			                //Data is loaded!!!

			                if (data['weather'].length < dataSize) {
			                	dataSize = data['weather'].length - 1
			                	initCut = Math.round(data['weather'].length / 2)
			                }

			            	sMin = new Date(data['weather'][dataSize][sField]*1000)
							sInit = new Date(data['weather'][initCut][sField]*1000)
							sMax = new Date(data['weather'][0][sField]*1000)
							mainChart.dxChart('instance').zoomArgument(sInit, sMax)

			                //addGauges(data['weather'][0])
							//addRangeSelector()
			                d.resolve(data)
			            }
			        });
			        return d.promise();
			    },
			    postProcess: function (data) {
			        var d = data[0]['weather']
			        for (i in d){
			            d[i][sField] = new Date(d[i][sField]*1000)
			        }
			        return d
			    }
			});


			$(function () {
			    tGauge = $('<div style="width: 20%; float: left;" />').appendTo('#dashboard')
				//mainChart = $('<div id="chart" style="width: 60%; float: left;" />').appendTo('#dashboard')
				hGauge = $('<div style="width: 20%; float: left;" />').appendTo('#dashboard')
				rangeSelector = $('<div style="clear:both;" />').appendTo('#dashboard')


				mainChart = $('<div id="chart" style="height: 90%;"" />').appendTo('#dashboard')

				drawChart()
			})

			
/*			function fetchLimits(){
				$.getJSON( "/discrete_weather.json?n=1," + dataSize + "," + (dataSize-initCut), function(data) {
					addGauges(data['weather'][0])

					sMin = new Date(data['weather'][1][sField]*1000)
					sInit = new Date(data['weather'][2][sField]*1000)
					sMax = new Date(data['weather'][0][sField]*1000)

					addRangeSelector()
					drawChart()

					setTimeout(loadData, 800);

				}).fail(function(jqxhr, textStatus, error) {
				    console.log( "Data request Failed: " + textStatus + ", " + error );
				})
			}
			function loadData(){
				dataSource.load().done(function(result) { 
					mainChart.dxChart('instance').option("dataSource", dataSource)
					mainChart.dxChart('instance').hideLoadingIndicator()
					mainChart.dxChart('instance').endUpdate()
					mainChart.dxChart('instance').zoomArgument(sInit, sMax)
				})
			}*/

			function addGauges(data){
				tGauge.dxCircularGauge({
					value: data[tOutField],
					scale: {
			            startValue: -20,
			            endValue: 30,
			            majorTick: {
			                color: 'black',
			                tickInterval: 5
			            },
			            minorTick: {
			                visible: true,
			                color: 'black',
			                tickInterval: 1
			            },
			        },
			        rangeContainer:{
			            ranges: [
			                { startValue: -20, endValue: -5, color: 'blue' },
			                { startValue: -5, endValue: 15, color: 'yellow' },
			                { startValue: 15, endValue: 30, color: 'orange' }
			            ],
           				offset: 5
			       	},
			       	valueIndicator: {
			       		type: 'triangleNeedle',
			       		width: 10
			       	},
			       	title:{
			       		text: data[tOutField] + ' °C',
			       		position: 'bottom-center'
			       	}
			    });

			    hGauge.dxCircularGauge({
					value: data[pField],
					subvalues: [1013.25],
					scale: {
			            startValue: 963.25,
			            endValue: 1063.25,
			            majorTick: {
			                color: 'black',
			                tickInterval: 5
			            },
			            minorTick: {
			                visible: true,
			                color: 'black',
			                tickInterval: 2
			            },
			       	},
			       	rangeContainer:{
			            ranges: [
			                { startValue: 963.25, endValue: 1013.24, color: 'blue' },
			                { startValue: 1013.26, endValue: 1063.25, color: 'red' }
			            ],
			            offset: 5
			       	},
			       	title:{
			       		text: data[pField] + ' hPa',
			       		position: 'bottom-center'
			       	},
			       	valueIndicator: {
			       		type: 'triangleNeedle',
			       		width: 10
			       	}
			    })
			}
			
			
			function drawChart(){
				var series = [
		        	{argumentField: sField, valueField: tInField, axis: tInField, name: tInName},
		        	{argumentField: sField, valueField: tOutField, axis: tOutField, name: tOutName},
		        	{argumentField: sField, valueField: luxField, axis: luxField, name: luxName},
		        	{argumentField: sField, valueField: pField, axis: pField, name: pName}]

	    		mainChart.dxChart({
			        dataSource: dataSource,
			        series: series,
			        commonSeriesSettings: {
			        	type: 'line',
			        	point: {visible: false}
			        },
			        argumentAxis: {
			        	grid: {visible: true}	
			        },
		    	    valueAxis: [
				        {name: tInField, title: tInField, position: 'left'},
				        {name: tOutField, title: tOutField, position: 'left'},
				        {name: luxField, title: luxField, position: 'right'},
				        {name: pField, title: pName, position: 'right', constantLines: [{value: 1013.25, label: {text: 'Normal atmospheric pressure'}, color:'#BA4D51'}]}
				    ],
				    legend: {
				    	verticalAlignment: 'bottom',
				    	horizontalAlignment: 'center',
				    	itemTextPosition: 'right'
				    },
				    tooltip: {
				    	enabled: true
				    },
				    zoomingMode: 'all',
				    scrollingMode: 'all',
				    useAggregation: true
			    })
			    mainChart.dxChart('instance').showLoadingIndicator()
			}
			

			
			function addRangeSelector(){
				rangeSelector.dxRangeSelector({
				    sliderMarker: {
				        format: "monthAndDay"
				    },
				    behavior: { 
				    	callSelectedRangeChanged: "onMoving",
				    	snapToTicks: false
				    },
				    onSelectedRangeChanged: function (e) {
				        var chart = mainChart.dxChart("instance");
				        chart.zoomArgument(e.startValue, e.endValue);
				    },
				    scale: {
			    		startValue: sMin,
						endValue: sMax
					},
			    	selectedRange: {
			    		startValue: sInit,
				    	endValue: sMax
				    }
				})
			}

		</script>

	<body>
		<div id="dashboard"></div>
		<p>WTF, give me pure data:
		<a href='himura_weather.csv?limit=576'>CSV</a>, 
		<a href='himura_weather.csv?limit=576&mode=excel&time=friendly'>Excel</a>, 
		<a href='himura_weather.json?limit=576'>JSON</a>,
		<a href='himura_weather.php?limit=144'>HTML</a>
		</p>
		<pre>$mysql --host=himura15.dlinkddns.com --user=user --password=user himura_weather</pre>
	</body>
</html>
