<?php 

$mysqli = new mysqli('localhost', 'user', 'user');
if ($mysqli->connect_errno) {
    echo "Не удалось подключиться: " + $mysqli->connect_error;
    exit();
}
$mysqli->select_db("himura_weather");

$friendly_time = false;
$query = "SELECT UNIX_TIMESTAMP(Timestamp), Temp, Pressure FROM tp ORDER BY Timestamp DESC";
if (isset($_GET['time'])){
	if ($_GET['time'] == 'friendly'){
		$friendly_time = true;
		$query = "SELECT * FROM tp ORDER BY Timestamp DESC";
	}
}

if (isset($_GET['limit'])){
	$query .= " LIMIT ?";
	$stmt = $mysqli->prepare($query);
	$stmt->bind_param("d", $_GET['limit']);
}else{
	$stmt = $mysqli->prepare($query);
}

if (isset($_GET['mode']) && $_GET['mode'] == 'excel'){
	$deс = ',';
	$delim = ';';
}
else{
	$deс = '.';
	$delim = ',';
}


if ($stmt->execute()) {
	$stmt->bind_result($Timestamp, $Temp, $Pressure);
	
	echo ($friendly_time ? "DateTime" : "Timestamp") . $delim . "Temp" . $delim . "Pressure";
	
	$first_elem = true;
	while($stmt->fetch()){
		$Temp = number_format($Temp / 10, 1, $deс, '');
		$Pressure = number_format(($Pressure + 101325) / 100, 2, $deс, '');

		if ($friendly_time) $Timestamp = "\"" . $Timestamp . "\"";

		echo "\n";
		echo $Timestamp . $delim;
		echo $Temp . $delim;
		echo $Pressure;
	}
    $stmt->close();
}
else{
	echo $mysqli->error;
}

$mysqli->close();

?>
