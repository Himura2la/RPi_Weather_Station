<?php 

function refValues($arr){ 
    if (strnatcmp(phpversion(),'5.3') >= 0) {
    	$refs = array(); 
        foreach($arr as $key => $value) 
            $refs[$key] = &$arr[$key]; 
        return $refs; } 
    return $arr; } 

$mysqli = new mysqli('localhost', 'user', 'user');
if ($mysqli->connect_errno) {
    echo "Не удалось подключиться: " + $mysqli->connect_error;
    exit();
}
$mysqli->select_db("himura_weather");

if (isset($_GET['n'])){
	$rows = explode(",", $_GET['n']);
	$i = count($rows);
} else{
	$i = 1;
	$rows = array(1);
}

	switch ($i) {
		case 1:
			$query = "SELECT UNIX_TIMESTAMP(Timestamp), Temp, Pressure FROM tp ORDER BY Timestamp DESC LIMIT 1 OFFSET ?";
			$stmt = $mysqli->prepare($query);
			$stmt->bind_param("i", $rows[0]);
			break;

		case 2:
			$query = "(SELECT UNIX_TIMESTAMP(Timestamp), Temp, Pressure FROM tp ORDER BY Timestamp DESC LIMIT 1 OFFSET ? ) UNION (SELECT UNIX_TIMESTAMP(Timestamp), Temp, Pressure FROM tp ORDER BY Timestamp DESC LIMIT 1 OFFSET ? )";
			$stmt = $mysqli->prepare($query);
			$stmt->bind_param("ii", $rows[0], $rows[1]);
			break;

		case 3:
			$query = "(SELECT UNIX_TIMESTAMP(Timestamp), Temp, Pressure FROM tp ORDER BY Timestamp DESC LIMIT 1 OFFSET ? ) UNION (SELECT UNIX_TIMESTAMP(Timestamp), Temp, Pressure FROM tp ORDER BY Timestamp DESC LIMIT 1 OFFSET ? ) UNION (SELECT UNIX_TIMESTAMP(Timestamp), Temp, Pressure FROM tp ORDER BY Timestamp DESC LIMIT 1 OFFSET ? )";
			$stmt = $mysqli->prepare($query);
			$stmt->bind_param("iii", $rows[0], $rows[1], $rows[2]);
			break;

		default:
			echo "need <= 3 arg";
			exit();
			break;
	}


		
	if ($stmt->execute()) {
		$stmt->bind_result($Timestamp, $Temp, $Pressure);
		echo "{\"weather\": [\n";
		$first_elem = true;
		
		while($stmt->fetch()){
			if (!$first_elem) echo ",";
			else $first_elem = false;
			echo "{\n";
			echo "\"Timestamp\": ". $Timestamp . ",\n";
			echo "\"Temp\": " . $Temp / 10 . ",\n";
			echo "\"Pressure\": " . ($Pressure + 101325) / 100 . "\n";
			echo "}";
		}
		echo "]}";
	    $stmt->close();
	}
	else{
		echo $mysqli->error;
	}

	$mysqli->close();

?>
